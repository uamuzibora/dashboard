<!DOCTYPE html>
<html>
<head>
	<title>The Spanish Inquisition </title>
	<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link type="text/css" rel="stylesheet" href="css/nv.d3.css">
</head>
<body>
	<!-- Le container -->
	<div class="container-fluid">
		<!-- Topbar -->
		<div class="navbar">
			<div class="navbar-inner">
			    <a class="brand" href="#">The Spanish Inquisition</a>
			</div>
		</div>
		<!-- End Topbar -->
		<!-- Content -->
		<div class="row-fluid">
			<div class="span3">
				<ul class="nav nav-list" id="tablist">
					<li class="active"><a href="#initial" data-toggle="pill">Initial Visit Form</a></li>
					<li><a href="#return" data-toggle="pill">Return Visit</a></li>
				</ul>
			</div>
			<!-- End Sidebar -->
			<!-- Data pane  -->
			<div class="span9 tab-content">
				<div class="tab-pane active" id="initial"></div>
				<div class="tab-pane" id="return"></div>

			</div>
			<!-- End Data pane -->
		</div>

	</div>
	<!-- Le Javascript at the bottom for speediness -->
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.js"></script>
	<script src="js/d3.v2.min.js"></script>
	<script src="js/nv.d3.min.js"></script>
	<script src="js/tooltip.js"></script>

	<script>
	function table(data){
  	     html='<table class="table table-bordered table-hover"> \
	          <tr><th>Name</th><td>Number of forms completed</td></tr>'
             for(name in data){
	     html+="<tr><td>"+name+"</td><td>"+data[name]+"</td></tr>"
             }
	     return html+'</table>';
	    };
	$(document).ready(function(){

	    $.post("http://localhost/backend",
	    {
	       request_type:"performance"
	    },
	    function(data,status){
	      jdata=jQuery.parseJSON(data);
              var keys=Object.keys(jdata);
	      keys.sort();
	      keys.reverse()
	      latest_date=keys[0]
	      $("#initial").html(table(jdata[latest_date]["initial"]));
	      $("#return").html(table(jdata[latest_date]["return"]));

	    });
  
	});
	  $(function () {
	    $('#tablist a:first').tab('show');
	  })
        function scale(data,scaling,scale,level){
            return_data={}
            for(key in data){
	    if(level==1){
	      return_data[key]=data[key]/scaling[key]*scale
            }if(level==2){
              return_data[key]={}
              for(key2 in data[key]){
	          return_data[key][key2]=data[key][key2]/scaling[key]*scale
              }
            }
            }
            return return_data
        }
        function percent_change(data,level,which){
            if(which=="total"){
            data=total_time_data(data,level)
            var keys=Object.keys(data)
            return (data[keys[keys.length-1]]-data[keys[0]])/data[keys[0]]*100
           }if(which=="individual"){
            var keys=Object.keys(data)
            return_data={}
            for(key in data[keys[0]]){
	        return_data[key]=(data[keys[keys.length-1]][key]-data[keys[0]][key])/data[keys[0]][key]*100
            }
            return return_data
          }
        }
        function extractTimeData(data,key,group){
           var keys=Object.keys(data);
	   keys.sort();
           var timedata={}
           if(!group){
           for (var i=0;i<keys.length;i++){
                 k=keys[i];

                 var date = new Date(k); 
                 var sum=0;
	         for(var j=0;j<4;j++){
		     for(var loc in data[k][key]){
	                 sum+=data[k][key][loc][j];

	                 }
                 
	         }

                 timedata[date.getTime()]=sum
          }}
          if(group=="location"){
	     for (var i=0;i<keys.length;i++){
                 k=keys[i];

                 var date = new Date(k); 
	         timedata[date.getTime()]={}
	         for(var loc in data[k][key]){
                    var sum=0; 
                    for(var j=0;j<4;j++){
	                  sum+=data[k][key][loc][j];
	             }
                     timedata[date.getTime()][loc]=sum;
                }
          }}
          if(group=="text"){
	  for (var i=0;i<keys.length;i++){
                 k=keys[i];
                 var date = new Date(k); 
	         timedata[date.getTime()]={}
                 for(var t in data[k][key]){

	             var sum=0; 
	                 for(var loc in data[k][key][t]){
                            for(var j=0;j<4;j++){
	                       sum+=data[k][key][t][loc][j];
	                    }
                        }
                    timedata[date.getTime()][t]=sum;
                }


          }
          }
          return timedata

        }
        function total_time_data(data,level){
	      ret_data={}
              for(k in data){
                  sum=0;
                  for(l in data[k]){
                  if (level==2){
                     for(j in data[k][j]){
                       sum+=data[k][l];
                     }
                  }else{
                       sum+=data[k][l];
                  }
                  }
	       ret_data[k]=sum
              }
             return ret_data
        }
        function line_chart(data,chart_id,scaling){

           var timedata_t={}
           keys=Object.keys(data)
           locations=Object.keys(data[keys[keys.length-1]]);

           max=0;
           max_number=0;
           for(var i=0;i<keys.length;i++){
               locs=Object.keys(data[keys[i]]);
               if (locs.length>max){
                   max=locs.length
                   max_number=i
               }               
           }
           for(loc in data[keys[max_number]]){
               timedata_t[loc]=[]
           }
           
	   for(var i=0;i<keys.length;i++){
               for(loc in data[keys[i]]){
                     ar=data[keys[i]][loc]
                     if(scaling){
                     scale=scaling[keys[i]]/100.0
                     }else{
                     scale=1
                     }                
   
	             timedata_t[loc].push([parseInt(keys[i]),data[keys[i]][loc]/scale]);
                }
	   }
          var timedata=[];
  
         for(loc in timedata_t){
	     timedata.push({"key":loc,"values":timedata_t[loc]})
          }
             nv.addGraph(function() {
              var chart_line = nv.models.lineWithFocusChart()
                 .x(function(d) { return d[0] })
                 .y(function(d) { return d[1] });
              chart_line.xAxis
                .showMaxMin(false)
                .tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });
             chart_line.x2Axis
		.showMaxMin(false)
                .tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

             chart_line.yAxis
               .tickFormat(d3.format(',.2f'));
             chart_line.y2Axis
              .tickFormat(d3.format(',.2f'));

	    d3.select('#'+chart_id+' svg')
            .datum(timedata)
            .transition().duration(500)
            .call(chart_line);

            nv.utils.windowResize(chart_line.update);

           return chart_line;
          });

     }
        function pie_chart(data,chart_id){
             datum=[]
             for(text in data){
	          datum.push({"label":text,"value":parseInt(data[text])})
             }
             datum=[{"key":"Stuff","values":datum}]
             nv.addGraph(function() {
                 var chart = nv.models.pieChart()
                .x(function(d) { return d.label })
                .y(function(d) { return d.value })
                .showLabels(false);

            d3.select("#"+chart_id+" svg")
                 .datum(datum)
                 .transition().duration(1200)
                 .call(chart);

            return chart;
            });



        }

        function timeline_nv(data,chart_id){
           timedata_t={}
           keys=Object.keys(data)
           locations=Object.keys(data[keys[keys.length-1]]);

	   max=0;
           max_number=0;
           for(var i=0;i<keys.length;i++){
               locs=Object.keys(data[keys[i]]);
               if (locs.length>max){
                   max=locs.length
                   max_number=i
               }               
           }
           for(loc in data[keys[max_number]]){
               timedata_t[loc]=[]
           }
	   for(var i=0;i<keys.length;i++){
                for(loc in data[keys[max_number]]){
                    if(loc in data[keys[i]]){
	             timedata_t[loc].push([parseInt(keys[i]),data[keys[i]][loc]]);
                    }else{
      	             timedata_t[loc].push([parseInt(keys[i]),0]);
                    }
                }
	   }
          var timedata=[];
          for(loc in timedata_t){
	     timedata.push({"key":loc,"values":timedata_t[loc]})
          }
  	  nv.addGraph(function() {
             var chart = nv.models.stackedAreaChart()
             .x(function(d) { return d[0] })
             .y(function(d) { return d[1] })
             .clipEdge(true);

             chart.xAxis
	          .showMaxMin(false)
                  .tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

             chart.yAxis
             .tickFormat(d3.format(',.2f'));

             d3.select("#"+chart_id+' svg')
             .datum(timedata)
             .transition().duration(500).call(chart);

             nv.utils.windowResize(chart.update);

        return chart;
});


        }

        function horizontal_bar_chart(data,chart_id){
             var datum=[{key:"Missing data",color: '#1f77b4',values:[]}]
	     for(key in data){
                 datum[0]["values"].push({"label":key,"value":data[key]})
             }
	     var chart;
             nv.addGraph(function() {
             chart = nv.models.multiBarHorizontalChart()
                .x(function(d) { return d.label })
                .y(function(d) { return d.value })
                .margin({top: 30, right: 20, bottom: 50, left: 175})
                .showValues(true)
                .tooltips(false)
                .showControls(false);

            chart.yAxis
                .tickFormat(d3.format(',.2f'));

            d3.select('#'+chart_id+' svg')
                .datum(datum)
                .transition().duration(500)
                .call(chart);

            nv.utils.windowResize(chart.update);



            return chart;
           });
        }
	</script>
	<!-- End Javascript -->
</body>
</html>
